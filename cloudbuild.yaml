steps:

    # step 1: build the both images backend and frontend
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/frontend:${SHORT_SHA}', './frontend' ]
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/backend:${SHORT_SHA}', './backend' ]

    # step 2: push both images to the GCR repository
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/frontend:${SHORT_SHA}']
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/backend:${SHORT_SHA}' ]

    # step 3: deploy application on kubernetes cluster using cloud deploy
  - name: "gcr.io/cloud-builders/gke-deploy"
    args:
      - run
      - --filename=./frontend/k8s-manifests/
      - --image=gcr.io/$PROJECT_ID/frontend:${SHORT_SHA}
      - --location=${location}
      - --cluster=web-app-cluster

  - name: "gcr.io/cloud-builders/gke-deploy"
    args:
      - run
      - --filename=./backend/k8s-manifests/
      - --image=gcr.io/$PROJECT_ID/backend:${SHORT_SHA}
      - --location=${location}
      - --cluster=web-app-cluster

logsBucket: 'gs://gcp-app-logs'